const gulp = require('gulp');
const uglify = require('gulp-uglify');
const rename = require('gulp-rename');
const ts = require('gulp-typescript');
const browserify = require('gulp-browserify');
const path = require('path');

const outputpath = path.join(__dirname, 'commonjs');
const cachepath = path.join(__dirname, 'cache');
const scriptsource = path.join(__dirname, 'src/**/*.ts');
const cachesource = path.join(__dirname, 'cache/sa/sa.js');

gulp.task('spider:ts:complied', function () {
    return gulp.src(scriptsource)
        .pipe(ts({
            noImplicitAny: true,
            module: "commonjs",
        }))
        .pipe(gulp.dest(cachepath));
});

gulp.task('spider:commonjs:complied', ['spider:ts:complied'], function () {
    return gulp.src(cachesource)
        .pipe(browserify({
            insertGlobals: false,
        }))
        .pipe(gulp.dest(outputpath))
        .pipe(uglify())
        .pipe(rename({
            extname: '.commonjs.min.js'
        }))
        .pipe(gulp.dest(outputpath));
});